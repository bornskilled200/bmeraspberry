<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <input type="number" placeholder="5000" oninput="updatePlot(event.target.value)">
  <div id="air" class="plotly-frame"></div>

  <script>
    const airDiv = document.getElementById('air');

    Plotly.newPlot(
      airDiv,
      [],
      {
        margin: { t: 30 },
        title: 'Air Quality (Higher is better)',
        yaxis: {
          side: 'right',
        },
      },
    );

    function updatePlot(results) {
      fetch(`conditions?results=${results}`)
        .then(response => response.json())
        .then(conditions => {
          const x = conditions.map(condition => new Date(condition.time * 1000));
          const conditionsR = conditions.slice(0).reverse();
          let previousMax = [];
          let level = conditionsR[0].air;
          let trend = conditionsR[1].air - conditionsR[0].air;
          const ALPHA = .15;
          const BETA = .2;
          Plotly.react(
            airDiv,
            [
              {
                x,
                y: conditions.map(condition => condition.air),
                name: 'Air Quality (Ohms)',
              },
              {
                x,
                y: conditionsR.map((condition, index) => {
                  if (previousMax.length && condition.air - previousMax[previousMax.length-1] > 10000) {
                    // previousMax.push(previousMax[previousMax.length - 1] + (previousMax[previousMax.length - 1] - condition.air) * .1); ignore crazy changes in values
                  } else {
                    previousMax.push(condition.air);                    
                  }
                  if (previousMax.length > 150) {
                    previousMax.shift();
                  }
                  return previousMax.reduce((accu, next) => next > accu ? next : accu);
                }).reverse(),
                name: 'Max',
              },
              {
                x,
                y: conditionsR.map((condition, index) => {
                  if (index === 0) {
                    return condition.air;
                  }
                  const lastLevel = level;
                  const value = condition.air;
                  level = ALPHA * value + (1-ALPHA) * (level + trend);
                  trend = BETA * (level - lastLevel) + (1 - BETA) * trend;

                  return level + trend;
                }).reverse(),
                name: 'Smoothing',
              },
            ],
            {
              margin: { t: 30 },
              title: 'Air Quality (Higher is better)',
              yaxis: {
                side: 'right',
              },
            },
          );
        });
    }
    updatePlot();
  </script>
</body>

</html>
